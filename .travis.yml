language: python
dist: xenial

env:
  global:
    secure: "d2LR/WLe9ZragzMEXGGjkFGoPiVm8ilCc41CEhnsJNRUzDo5crfZY1OTzE45CIx3kpVYgUNUveb37Q2WMYI9X7xJp4gY+gxEOWG4EMefkXu2IwUBzwKaqA0oU1pYcnm5FlU8MoBL3HBWagTvGG7Q90YR4s/78HJTDrwHjTAlZctyh5O89vHq8yjDDa/FIwEytns3U8FsVp5IGe+vvDBsbrlFgW0kGG2ayc2bO0i9wof0RF9J7gre5zrKg9h80AHxbmprZ9hhjsYPj3cgEniaQn5dFxf7k3YfkPMvr2h9HHdHPucF+KRiux2/UvQ/CPeSpZGmcC+YzHcgliKK/bkl2MHZDQJ78V+vhJKchbZ+3iVyuFYbhggE5nmUjDMpthnfhraGGIPc9ZYwwKTYhLMc2AlcBLu3+cLAAcCT7gl4ArZQT6+1jXrMApulPIHqxsnxwTKxBPyuq0M7w5TJJMpgXGy4l5xUO/z8FYAQ1+rBHif3Sy36Sh2w0cAAKCz46dow5ZdpXhxUurA9VeCkQRb0D/fg59N/KoAnsjbbbgUyg3zjsxF8OiLMqyOTnagecFzCMUjT8yT0cknEz8oCwznEbP3seqzGevTzmC8yXXAhAFeaGwdh8t7WkOT5I50cOZ+bNgnyi1nsiEBzaGDNEVtd+uI91Ij5GTT54ZRoXBxaS0k="

matrix:
  fast_finish: true
  include:
    - python: 3.7
      env: TOXENV=doc_build
    - python: 3.7
      env: TOXENV=lint
    - python: 3.8
      env: TOXENV=INTEGRATION
    - python: 3.8
      env: TOXENV=py38
    - python: nightly
      env: TOXENV=py3
  allow_failures:
    - python: nightly

install:
    - pip install --upgrade pip setuptools
    - pip install -r requirements.txt -r requirements_test.txt
    - pip install .

script:
    - python test_runner.py

notifications:
  irc:
    channels:
      - "chat.freenode.net#bandersnatch"

cache:
    directories:
        - $HOME/.cache/pip
        - $HOME/.cache/pre-commit

jobs:
  include:
    - stage: Docker
      env:
        DOCKER_USERNAME=pypa
        secure: xc5vP+LjpNnZgMIfXUUeP3EBGhhNoDV5vTfophBliaWZrBX8POpLOFQGZ/Fcd0i+UBmSckLYW30BLSwHwjYLAZJGM12AfeiKbI1eub5tNfsosI2FZ3lNeb2nlpoIjzpsyS5fknJL0zQfkadUgxbrwDRDuaN+P6oOup3XMgHR9hkjb/QwVW2ozxU+OP4iRvcNECLP+XqnsOyq0YFshZzRMOd6fVYnJZuP6NTj24hCfymcmZJlS8Q5dSHISg68Lckaa/z3APxrMW+5/PORsHZ/U8yugNQr6Ty5J3YoaEuUoaMaUkGpaiuP26/lndynlRhNVlw8zQKfb7A09oom/UjnhyLE+9NuhKpo7f3l56OP/ubIvJzkrGt0hqwKnW2+EixURLxAOL7shtc/9gl8q2cPwEJg50siIRGJXkUEear/oqYr/EqEk1/6kq3dOfaDM0kRYAeHi8Kuf4+tyTbKQDULT3xYMi3ZxAYTd8gEMGsWca+PT/+IfFB4sHADmFmh6Y9VhI89Zrsrqa7C2BlS/ytuiAJHgrleKxyYKEFy78yG5Tb/AGi2UmGFMk8ShKRNrK8VJmrqixWttvyUr81iBI5uEP9copsXDnR5aZaFZF5vBi7PK85Ngwj6uREM+rjQadaPR49KQqUXFj0s3OXbwDXgMFIXAguqsji/nm4IuEeA8zA=
        DOCKER_IMAGE=pypa/bandersnatch
      script:
        - docker build -t $DOCKER_IMAGE"
      deploy:
        - provider: script
          script: docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
                  docker push "$DOCKER_IMAGE"
          on:
            branch: master
